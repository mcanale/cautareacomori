<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <title class="title">Căutarea comori dB</title>
    
  </head>
  <body>
  <div class="container-fluid text-center">
  
  <div class="alert alert-primary" role="alert">
    <h1>Căutarea comori don Bosco</h1>
    <h3>Echipă: <span id="team"></span>.</h3>
    <h3>Etapa n° <span id="tappa"></span> din <span id="stages"></span>.</h3>
  </div>
  <br>
  <div id="sezioneIniziale" class="d-none">
    <p>Mergi la coordonate: <span id="latitude"></span>,<span id="longitude"></span></p>
    <a id="linkMap" href="#" target="_blank" class="btn btn-primary" role="button" >Deschide harta într-o nouă filă</a>
    <br><br>
    <p>La <span id="ora">??</span> tu ești <span id="distanza">??</span> metri departe.</p>
    <p>Distanța maxima: <span id="maxDistance"></span> metri.</p>
    <button type="button" class="btn btn-primary" onclick="rilevaPosizione()">Detectați locația</button>
  </div>
  <br><br>
  <div id="sezioneDomanda" class="alert alert-success d-none" role="alert">
    <p id="question"></p>
    <input type="text" id="risposta" class="container-fluid">
    <br><br>
    <button type="button" class="btn btn-danger" onclick="controllaRisposta()">Confirmă răspunsul</button>
  </div>

  <div id="sezioneTappaSuccessiva" class="d-none" role="alert">
    <a id="linkTappaSuccessiva" href="#" class="btn btn-primary btn-lg" role="button" >Următoarea oprire!</a>
  </div>

  <div id="rispostaNegativa" class="alert alert-danger d-none" role="alert"></div>
  
  </div>
  </body>
<script type="text/javascript">
const webAppLink = 'https://script.google.com/macros/s/AKfycbzwUsjq2IGjV-8Z1CWDySXjwXD1fFL_8s7dG5C5E6bGtnLz1FU/exec';
let maxDist = 7;   // massima distanza in metri
let risposta = '';
onLoad();

function onLoad() {
  if (!navigator.geolocation)
    elaboraErrore('Geolocation NOT possible');
  else 
    caricaInformazioni();
}

// funzione per preparare le informazioni della pagina al caricamento
function caricaInformazioni() {
  const urlParams = new URLSearchParams(window.location.search);
  const team = urlParams.get('team');
  const tappa = urlParams.get('tappa');
  document.getElementById('tappa').innerHTML = tappa;
  
  const url = `${webAppLink}?team=${team}&tappa=${tappa}`;
  fetch(url).then( response => {
    if (response.ok) {  
      return response.json();    // .text() or .json()
    }
  }).then( formattedResponse => {   // {"latitude":44.15456,"longitude":28.6082,"question":"domanda8?","answer":"risposta8","team":"Marian","stages":9,"maxDistance":7}
    // prende tutte le proprietà della risposta (vedi elenco sopra) e le assegna ai rispettivi campi 
    // tranne risposta che la salva solamente e distanza che anche la salva
    risposta = formattedResponse.answer;
    delete formattedResponse.answer;
    maxDist = formattedResponse.maxDistance;
    const properties = Object.keys(formattedResponse);
    properties.forEach( proprieta => {
      document.getElementById(proprieta).innerHTML = formattedResponse[proprieta];
    });
    // prepara il link per l'apertura dei Maps con le coordinate
    const linkMap = `https://www.google.com/maps/search/?api=1&query=${formattedResponse['latitude']},${formattedResponse['longitude']}`;
    document.getElementById('linkMap').href = linkMap;
    // mostra la sezione iniziale con le coordinate e i pulsanti
    document.getElementById('sezioneIniziale').classList.remove("d-none");
    // prepara il link per la tappa successiva controllando che non siamo all'ultima tappa
    if (tappa == formattedResponse['stages']) {
      document.getElementById('linkTappaSuccessiva').innerHTML = 'AI AJUNS LA FINAL! COMPLIMENTE!';
    } else {
      const linkTappaSuccessiva = `cautarea.html?team=${team}&tappa=${parseInt(tappa)+1}`;
      document.getElementById('linkTappaSuccessiva').href = linkTappaSuccessiva;
    }    
  }).catch( error => {               
    elaboraErrore('Stage loading failed');
  });
}

// funzione azionata dal bottone rileva posizione che rileva la posizione e ne gestisce le conseguenze
function rilevaPosizione() {
  console.log('rilevaPosizione');
  navigator.geolocation.getCurrentPosition(elaboraPosizione, elaboraErrore, { enableHighAccuracy: true });
}

function elaboraPosizione(position) {
  console.log('elaboraPosizione');
  const currentLat = position.coords.latitude;
  const currentLon = position.coords.longitude;
  const currentTime = new Date(position.timestamp).toLocaleTimeString();
  const latToFind = document.getElementById('latitude').innerHTML;
  const lonToFind = document.getElementById('longitude').innerHTML;

  let distanza = calcolaDistanza(currentLat, currentLon, latToFind, lonToFind).toFixed(2);
  // distanza = 5; // usato solo per testare
  document.getElementById('distanza').innerHTML = distanza;
  document.getElementById('ora').innerHTML = currentTime;

  const sezioneDomanda = document.getElementById('sezioneDomanda');
  const rispostaNegativa = document.getElementById('rispostaNegativa');
  if (distanza > maxDist) {
    rispostaNegativa.classList.remove("d-none");
    rispostaNegativa.innerHTML = "Prea departe..."
  } else {
    rispostaNegativa.classList.add("d-none");
    sezioneDomanda.classList.remove("d-none");
    mandaSegnale();
  }
}

// funzione che manda un segnale al server per far segnare l'arrivo al luogo
function mandaSegnale() {
  const urlParams = new URLSearchParams(window.location.search);
  const data = {
    team: urlParams.get('team'),
    tappa: urlParams.get('tappa'),
  };
  fetch(webAppLink, {
    method: 'POST',
    body: JSON.stringify(data),
  }).then( response => {
    return response.json(); 
  }).then( data => {   
    console.log('Success:', data);
  }).catch( error => {               
    console.log('Error:', error);
  });
}

// funzione che calcola la distanza tra due punti dando le rispettive coordinate
function calcolaDistanza(latA, lonA, latB, lonB) {
  console.log(latA, lonA, latB, lonB);
  let deg2rad = function (degrees) {
    return degrees * (Math.PI/180);
  }
  const raggioTerra = 6372.795477598 * 1000; // in metri
  let distanzaAB = raggioTerra * Math.acos(Math.sin(deg2rad(latA)) * Math.sin(deg2rad(latB)) + Math.cos(deg2rad(latA)) * Math.cos(deg2rad(latB)) * Math.cos(deg2rad(lonA-lonB)));
  return distanzaAB;
}

// funzione azionata dal bottone che controlla se la risposta è corretta
function controllaRisposta() {
  let miaRisposta = document.getElementById('risposta').value;
  const sezioneTappaSuccessiva = document.getElementById('sezioneTappaSuccessiva');
  const rispostaNegativa = document.getElementById('rispostaNegativa');
  if (miaRisposta.toUpperCase() != risposta.toString().toUpperCase()) {
    rispostaNegativa.classList.remove("d-none");
    rispostaNegativa.innerHTML = "Răspuns greșit, încearcă din nou..."
  } else {
    rispostaNegativa.classList.add("d-none");
    sezioneTappaSuccessiva.classList.remove("d-none");
  }
}

function elaboraErrore(errore) {
  console.log('ERRORE:', errore);
  alert('ERRORE: ' + errore.message);
}

</script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
</html>
